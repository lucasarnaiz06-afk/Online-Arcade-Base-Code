<!DOCTYPE html>
<html lang="en">
<head>
  {% if current_user.is_authenticated %}
  <script>
      window.addEventListener('DOMContentLoaded', function () {
          const serverTheme = "{{ current_user.theme }}";
          localStorage.setItem('theme', serverTheme);
          if (typeof applyTheme === 'function') {
              applyTheme(serverTheme);
          }
      });
  </script>
  {% endif %}
  <script src="/js/theme-init.js"></script> 
  <script src="{{ url_for('static', filename='js/theme-init.js') }}"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ðŸªœ Ladder Climb - Arcade</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
    
    /* Main game container - consistent gradient background */
    .game-container {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 20px;
      padding: 30px;
      position: relative;
      overflow: hidden;
      min-height: 600px;
    }
    
    .game-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 50%, rgba(255,255,255,0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 50%, rgba(255,255,255,0.1) 0%, transparent 50%);
      pointer-events: none;
    }
    
    /* Unified card styling */
    .game-card {
      background: rgba(0,0,0,0.2);
      border-radius: 15px;
      padding: 25px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      position: relative;
      z-index: 1;
      color: white;
    }
    
    .info-panel {
      background: linear-gradient(135deg, rgba(0,0,0,0.3), rgba(0,0,0,0.1));
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      border-radius: 15px;
      padding: 25px;
    }
    
    /* Start game form styling */
    .start-game-form {
      text-align: center;
    }
    
    .start-game-form h2 {
      background: linear-gradient(45deg, #ffd700, #ffed4a);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-family: 'Orbitron', monospace;
      font-weight: 700;
      margin-bottom: 30px;
      font-size: 2.5rem;
    }
    
    .form-group {
      margin-bottom: 25px;
      text-align: left;
    }
    
    .form-label {
      color: rgba(255,255,255,0.9);
      font-weight: 600;
      margin-bottom: 8px;
      display: block;
    }
    
    .form-control, .form-select {
      background: rgba(255,255,255,0.1);
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 10px;
      color: white;
      padding: 12px 15px;
      transition: all 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
      background: rgba(255,255,255,0.15);
      border-color: #ffd700;
      box-shadow: 0 0 0 0.2rem rgba(255,215,0,0.25);
      color: white;
    }
    
    .form-control::placeholder {
      color: rgba(255,255,255,0.6);
    }
    
    .form-select option {
      background: #343a40;
      color: white;
    }
    
    .input-group-text {
      background: rgba(255,255,255,0.1);
      border: 2px solid rgba(255,255,255,0.2);
      color: white;
      border-right: none;
    }
    
    .form-text {
      color: rgba(255,255,255,0.7);
      font-size: 0.875rem;
    }
    
    /* Ladder board styling */
    .ladder-board {
      position: relative;
      z-index: 1;
    }
    
    .ladder-row {
      display: flex;
      justify-content: center;
      margin-bottom: 15px;
      position: relative;
    }
    
    .ladder-step {
      width: 80px;
      height: 50px;
      margin: 0 8px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      position: relative;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border: 2px solid transparent;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .ladder-step:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }
    
    .ladder-step.revealed {
      animation: revealStep 0.5s ease-out;
    }
    
    .ladder-step.clicked {
      animation: clickStep 0.3s ease-out;
    }
    
    @keyframes revealStep {
      0% { transform: scale(0.8) rotateY(180deg); opacity: 0; }
      50% { transform: scale(1.1) rotateY(90deg); }
      100% { transform: scale(1) rotateY(0deg); opacity: 1; }
    }
    
    @keyframes clickStep {
      0% { transform: scale(1); }
      50% { transform: scale(0.95); }
      100% { transform: scale(1); }
    }
    
    @keyframes explosion {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.3); opacity: 0.8; }
      100% { transform: scale(0.8); opacity: 0; }
    }
    
    .ladder-step.exploding {
      animation: explosion 0.6s ease-out;
    }
    
    .safe-step {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      border-color: #20c997;
    }
    
    .safe-step::before {
      content: 'âœ“';
      position: absolute;
      font-size: 20px;
      font-weight: bold;
      animation: checkmark 0.5s ease-out;
    }
    
    @keyframes checkmark {
      0% { transform: scale(0) rotate(180deg); opacity: 0; }
      100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }
    
    .fail-step {
      background: linear-gradient(135deg, #dc3545, #e74c3c);
      color: white;
      border-color: #e74c3c;
      position: relative;
    }
    
    .fail-step::before {
      content: 'ðŸ’¥';
      position: absolute;
      font-size: 20px;
      animation: bomb 0.5s ease-out;
    }
    
    @keyframes bomb {
      0% { transform: scale(0) rotate(-180deg); opacity: 0; }
      50% { transform: scale(1.2) rotate(-90deg); opacity: 1; }
      100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }
    
    .neutral-step {
      background: linear-gradient(135deg, #6c757d, #495057);
      color: rgba(255,255,255,0.9);
      border-color: #495057;
    }
    
    .unrevealed-step {
      background: linear-gradient(135deg, #343a40, #495057);
      color: rgba(255,255,255,0.7);
      border: 2px dashed rgba(255,255,255,0.3);
    }
    
    .player-choice {
      box-shadow: 0 0 20px rgba(255,255,255,0.5);
      border-color: #ffd700 !important;
      transform: scale(1.05);
    }
    
    .choice-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 25px;
    }
    
    .btn-choice {
      width: 100px;
      height: 60px;
      border-radius: 15px;
      font-weight: 600;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: all 0.3s ease;
      background: linear-gradient(135deg, #007bff, #0056b3);
      border: none;
      color: white;
      box-shadow: 0 4px 15px rgba(0,123,255,0.3);
    }
    
    .btn-choice:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0,123,255,0.4);
      background: linear-gradient(135deg, #0056b3, #004085);
    }
    
    .btn-choice:active {
      transform: translateY(-1px);
    }
    
    /* Stats styling */
    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .stat-value {
      font-family: 'Orbitron', monospace;
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 5px;
      background: linear-gradient(45deg, #ffd700, #ffed4a);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .stat-label {
      font-size: 0.9rem;
      opacity: 0.8;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .multiplier-glow {
      animation: glow 2s ease-in-out infinite alternate;
    }
    
    @keyframes glow {
      from { text-shadow: 0 0 10px rgba(255,215,0,0.5); }
      to { text-shadow: 0 0 20px rgba(255,215,0,0.8), 0 0 30px rgba(255,215,0,0.6); }
    }
    
    /* Cash out card */
    .cash-out-section {
      background: linear-gradient(135deg, #28a745, #20c997);
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      color: white;
      position: relative;
      overflow: hidden;
      margin-top: 20px;
    }
    
    .cash-out-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }
    
    .cash-out-amount {
      font-family: 'Orbitron', monospace;
      font-size: 1.4rem;
      font-weight: 700;
    }
    
    .btn-cash-out {
      background: rgba(255,255,255,0.2);
      border: 2px solid rgba(255,255,255,0.3);
      color: white;
      font-weight: 600;
      transition: all 0.3s ease;
      border-radius: 10px;
      padding: 10px 20px;
    }
    
    .btn-cash-out:hover {
      background: rgba(255,255,255,0.3);
      border-color: rgba(255,255,255,0.5);
      transform: translateY(-2px);
      color: white;
    }
    
    /* Game over styling */
    .game-over-section {
      text-align: center;
      padding: 30px;
      margin-top: 20px;
    }
    
    .game-over-icon {
      font-size: 4rem;
      margin-bottom: 20px;
      animation: bounce 1s ease-in-out;
    }
    
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-20px); }
      60% { transform: translateY(-10px); }
    }
    
    /* Button styling */
    .btn-start, .btn-primary {
      background: linear-gradient(135deg, #28a745, #20c997);
      border: none;
      border-radius: 12px;
      padding: 15px 25px;
      font-weight: 600;
      font-size: 1.1rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: all 0.3s ease;
      color: white;
    }
    
    .btn-start:hover, .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(40,167,69,0.3);
      background: linear-gradient(135deg, #20c997, #17a2b8);
      color: white;
    }
    
    /* Ladder rail */
    .ladder-rail {
      position: absolute;
      left: 50%;
      top: 0;
      bottom: 0;
      width: 4px;
      background: linear-gradient(to bottom, #ffd700, #ffed4a);
      transform: translateX(-50%);
      border-radius: 2px;
      box-shadow: 0 0 10px rgba(255,215,0,0.3);
    }
    
    .row-number {
      position: absolute;
      left: -30px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.2);
      color: white;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }
    
    /* Particle effects */
    .particle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: #ffd700;
      border-radius: 50%;
      pointer-events: none;
      animation: particle 2s linear infinite;
    }
    
    @keyframes particle {
      0% { opacity: 1; transform: translateY(0) scale(1); }
      100% { opacity: 0; transform: translateY(-50px) scale(0); }
    }
    
    /* Dark theme adjustments */
    .dark-theme .form-control,
    .dark-theme .form-select {
      background: rgba(255,255,255,0.1);
      border-color: rgba(255,255,255,0.2);
      color: white;
    }
    
    .dark-theme .form-control:focus,
    .dark-theme .form-select:focus {
      background: rgba(255,255,255,0.15);
      border-color: #ffd700;
      color: white;
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
      .ladder-step {
        width: 70px;
        height: 45px;
        font-size: 11px;
      }
      
      .btn-choice {
        width: 85px;
        height: 55px;
        font-size: 12px;
      }
      
      .game-container {
        padding: 20px;
        margin: 10px;
      }
      
      .info-panel {
        padding: 20px;
        margin-bottom: 20px;
      }
    }
    
    /* Welcome screen styling */
    .welcome-content {
      text-align: center;
      padding: 40px 20px;
    }
    
    .welcome-icon {
      font-size: 5rem;
      margin-bottom: 30px;
      background: linear-gradient(45deg, #ffd700, #ffed4a);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    .welcome-description {
      color: rgba(255,255,255,0.9);
      font-size: 1.1rem;
      line-height: 1.6;
      margin-bottom: 30px;
    }
    .ladder-step {
      pointer-events: none;  /* Prevent these from blocking buttons */
    }

    .choice-buttons form button {
      pointer-events: auto; /* Allow buttons to stay clickable */
    }

  </style>
</head>
<body>
  {% include 'navbar.html' %}

  <div class="container mt-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-4">
        <div class="info-panel">
          <h5 class="mb-3">
            <i class="bi bi-ladder"></i> Game Info
          </h5>
          
          {% if game %}
            <div class="text-center mb-4">
              <h4 class="mb-3">ðŸªœ Ladder Climb</h4>
              <div class="row">
                <div class="col-6">
                  <div class="stat-item">
                    <div class="stat-value">{{ game.level }}</div>
                    <div class="stat-label">Level</div>
                  </div>
                </div>
                <div class="col-6">
                  <div class="stat-item">
                    <div class="stat-value multiplier-glow">{{ "%.2f"|format(game.multiplier) }}x</div>
                    <div class="stat-label">Multiplier</div>
                  </div>
                </div>
              </div>
            </div>
          {% else %}
            <div class="text-center">
              <i class="bi bi-controller welcome-icon"></i>
              <h4 class="mb-3">ðŸªœ Ladder Climb</h4>
              <p class="text-muted">Climb the Ladder for Higher Multipliers!</p>
              <small class="text-muted d-block mt-2">
                Choose your difficulty and start climbing to win big!
              </small>
            </div>
          {% endif %}
        </div>

        {% if current_user.is_authenticated %}
        <div class="info-panel mt-3">
          <h5 class="mb-3">
            <i class="bi bi-wallet2"></i> Your Balance
          </h5>
          <div class="text-center">
            <div class="stat-value">{{ current_user.coins }}</div>
            <div class="stat-label">Coins Available</div>
          </div>
        </div>
        {% endif %}

        {% if game and game['active'] %}
        <div class="cash-out-section">
          <div class="mb-3">
            <small>Cash out for:</small>
            <div class="cash-out-amount">{{ "%.0f"|format(game.bet * game.multiplier) }} Coins</div>
          </div>
          <div class="d-grid">
            <a href="{{ url_for('ladder_cashout') }}" class="btn btn-cash-out">
              <i class="bi bi-piggy-bank"></i> Cash Out
            </a>
          </div>
        </div>
        {% endif %}
      </div>

      <!-- Main Game Area -->
      <div class="col-md-8">
        <div class="game-container">
          {% if not game %}
            <!-- Start Game Form -->
            <div class="game-card">
              <div class="start-game-form">
                <h2>ðŸªœ Start Your Climb</h2>
                
                <div class="welcome-description mb-4">
                  Climb the ladder by choosing the right path! Each level increases your multiplier, 
                  but one wrong step and you'll fall down. Cash out anytime to secure your winnings!
                </div>

                <form method="POST">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  
                  <div class="form-group">
                    <label class="form-label">
                      <i class="bi bi-coin"></i> Enter Bet Amount
                    </label>
                    <div class="input-group">
                      <span class="input-group-text">
                        <i class="bi bi-coin"></i>
                      </span>
                      <input type="number" name="bet" class="form-control" 
                             min="1" max="{{ current_user.coins if current_user.is_authenticated else 100 }}" 
                             placeholder="Enter your bet..." required>
                    </div>
                    {% if current_user.is_authenticated %}
                      <div class="form-text">
                        You have {{ current_user.coins }} coins available
                      </div>
                    {% endif %}
                  </div>

                  <div class="form-group">
                    <label class="form-label">
                      <i class="bi bi-gear"></i> Choose Difficulty
                    </label>
                    <select name="safe_spots" class="form-select" required>
                      <option value="">Select difficulty level...</option>
                      <option value="1">ðŸ”¥ Hard Mode - 1 Safe Spot (Higher Multiplier)</option>
                      <option value="2">âš¡ Easy Mode - 2 Safe Spots (Lower Multiplier)</option>
                    </select>
                    <div class="form-text">
                      Harder difficulty = Higher potential rewards!
                    </div>
                  </div>

                  <div class="d-grid">
                    <button class="btn btn-start btn-lg">
                      <i class="bi bi-play-fill"></i> Start Climbing
                    </button>
                  </div>
                </form>
              </div>
            </div>
          {% else %}
            <!-- Active Game -->
            <div class="game-card">
              <div class="ladder-board">
                <div class="ladder-rail"></div>
                
                {% for step in game.history %}
                  <div class="ladder-row">
                    <div class="row-number">{{ loop.revindex }}</div>
                    {% for pos in ['left', 'middle', 'right'] %}
                      {% set is_choice = step.choice == pos %}
                      {% set is_safe = pos in step.safes %}
                      {% set failed = not step.success and is_choice and not is_safe %}
                      <div class="ladder-step revealed
                        {% if is_choice %}player-choice{% endif %}
                        {% if is_safe %}safe-step{% elif is_choice and not is_safe %}fail-step{% elif step.choice %}neutral-step{% else %}unrevealed-step{% endif %}
                        {% if failed %}exploding{% endif %}
                      ">
                        {% if not step.choice %}{{ pos.capitalize() }}{% endif %}
                      </div>
                    {% endfor %}
                  </div>
                {% endfor %}

                {% if game['active'] %}
                  <div class="choice-buttons">
                    <form method="POST" action="{{ url_for('ladder_pick', choice='left') }}">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button type="submit" class="btn btn-choice" onclick="this.classList.add('clicked')">
                        <i class="bi bi-arrow-left"></i><br>Left
                      </button>
                    </form>
                    <form method="POST" action="{{ url_for('ladder_pick', choice='middle') }}">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button type="submit" class="btn btn-choice" onclick="this.classList.add('clicked')">
                        <i class="bi bi-arrow-up"></i><br>Middle
                      </button>
                    </form>
                    <form method="POST" action="{{ url_for('ladder_pick', choice='right') }}">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button type="submit" class="btn btn-choice" onclick="this.classList.add('clicked')">
                        <i class="bi bi-arrow-right"></i><br>Right
                      </button>
                    </form>
                  </div>
                {% endif %}
              </div>

              {% if not game['active'] %}
                <div class="game-over-section">
                  <div class="game-over-icon">
                    {% if game.history and game.history[-1].success %}
                      <i class="bi bi-trophy-fill text-warning"></i>
                    {% else %}
                      <i class="bi bi-exclamation-triangle-fill text-danger"></i>
                    {% endif %}
                  </div>
                  <h3>Game Over!</h3>
                  <p class="mb-4">
                    {% if game.history and game.history[-1].success %}
                      ðŸŽ‰ Congratulations! You successfully cashed out and climbed to victory!
                    {% else %}
                      ðŸ’¥ Better luck next time! Ready for another climb up the ladder?
                    {% endif %}
                  </p>
                  <a href="{{ url_for('ladder_reset') }}" class="btn btn-primary btn-lg">
                    <i class="bi bi-arrow-clockwise"></i> Play Again
                  </a>
                </div>
              {% endif %}
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <footer class="bg-dark text-white text-center py-3 mt-5">
    <p>&copy; 2025 Online Arcade. All rights reserved.</p>
  </footer>

  <script>
    // Add particle effects when revealing steps
    function createParticles(element) {
      for (let i = 0; i < 5; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.animationDelay = Math.random() * 0.5 + 's';
        element.appendChild(particle);
        
        setTimeout(() => particle.remove(), 2000);
      }
    }
    
    // Add particle effects to revealed steps
    document.addEventListener('DOMContentLoaded', function() {
      const revealedSteps = document.querySelectorAll('.ladder-step.revealed');
      revealedSteps.forEach(step => {
        if (step.classList.contains('safe-step') || step.classList.contains('fail-step')) {
          createParticles(step);
        }
      });
      
      // Add subtle animation to welcome icon
      const welcomeIcon = document.querySelector('.welcome-icon');
      if (welcomeIcon) {
        welcomeIcon.addEventListener('mouseenter', function() {
          this.style.transform = 'scale(1.1) rotate(5deg)';
        });
        welcomeIcon.addEventListener('mouseleave', function() {
          this.style.transform = 'scale(1) rotate(0deg)';
        });
      }
    });
    
    // Enhanced click feedback for choice buttons
    document.querySelectorAll('.btn-choice').forEach(btn => {
      btn.addEventListener('click', function() {
        // Add click feedback
        this.style.transform = 'scale(0.95)';
        
        // Create ripple effect
        const ripple = document.createElement('div');
        ripple.style.position = 'absolute';
        ripple.style.borderRadius = '50%';
        ripple.style.background = 'rgba(255,255,255,0.6)';
        ripple.style.transform = 'scale(0)';
        ripple.style.animation = 'ripple 0.6s linear';
        ripple.style.left = '50%';
        ripple.style.top = '50%';
        ripple.style.width = '10px';
        ripple.style.height = '10px';
        ripple.style.marginLeft = '-5px';
        ripple.style.marginTop = '-5px';
        
        this.appendChild(ripple);
        
        setTimeout(() => {
          this.style.transform = '';
          ripple.remove();
        }, 600);
      });
    });
    
    // Add ripple animation keyframes
    const style = document.createElement('style');
    style.textContent = `
      @keyframes
      ripple {
        0% { transform: scale(0); opacity: 1; }
        100% { transform: scale(4); opacity: 0; }
      }
    `;
    document.head.appendChild(style);
    
    // Auto-focus bet input when page loads
    document.addEventListener('DOMContentLoaded', function() {
      const betInput = document.querySelector('input[name="bet"]');
      if (betInput) {
        betInput.focus();
      }
    });
    
    // Add smooth scrolling to ladder board
    function scrollToLatestRow() {
      const latestRow = document.querySelector('.ladder-row:last-child');
      if (latestRow) {
        latestRow.scrollIntoView({ 
          behavior: 'smooth', 
          block: 'center' 
        });
      }
    }
    
    // Call scroll function if there are ladder rows
    if (document.querySelector('.ladder-row')) {
      setTimeout(scrollToLatestRow, 500);
    }
    
    // Add sound effects (using Web Audio API)
    function playClickSound() {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
      oscillator.frequency.exponentialRampToValueAtTime(400, audioContext.currentTime + 0.1);
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.1);
    }
    
    function playSuccessSound() {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.setValueAtTime(523, audioContext.currentTime);
      oscillator.frequency.setValueAtTime(659, audioContext.currentTime + 0.1);
      oscillator.frequency.setValueAtTime(784, audioContext.currentTime + 0.2);
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.3);
    }
    
    function playFailSound() {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
      oscillator.frequency.exponentialRampToValueAtTime(100, audioContext.currentTime + 0.5);
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.5);
    }
    
    // Add sound to buttons
    document.querySelectorAll('.btn-choice').forEach(btn => {
      btn.addEventListener('click', playClickSound);
    });
    
    // Play appropriate sounds based on game state
    const safeSteps = document.querySelectorAll('.safe-step');
    const failSteps = document.querySelectorAll('.fail-step');
    
    if (safeSteps.length > 0) {
      setTimeout(playSuccessSound, 300);
    }
    
    if (failSteps.length > 0) {
      setTimeout(playFailSound, 300);
    }
    
    // Add keyboard controls
    document.addEventListener('keydown', function(event) {
      if (document.querySelector('.choice-buttons')) {
        switch(event.key) {
          case 'ArrowLeft':
          case 'a':
          case 'A':
            event.preventDefault();
            document.querySelector('form[action*="left"] button')?.click();
            break;
          case 'ArrowUp':
          case 'w':
          case 'W':
            event.preventDefault();
            document.querySelector('form[action*="middle"] button')?.click();
            break;
          case 'ArrowRight':
          case 'd':
          case 'D':
            event.preventDefault();
            document.querySelector('form[action*="right"] button')?.click();
            break;
        }
      }
    });
    
    // Add tooltips for keyboard controls
    const choiceButtons = document.querySelectorAll('.btn-choice');
    if (choiceButtons.length > 0) {
      choiceButtons[0].title = 'Left Arrow or A key';
      choiceButtons[1].title = 'Up Arrow or W key';
      choiceButtons[2].title = 'Right Arrow or D key';
    }
    
    // Prevent double-clicks without blocking form submission
    document.querySelectorAll('.btn-cash-out').forEach(btn => {
      btn.addEventListener('click', function() {
        this.disabled = true;
        setTimeout(() => {
          this.disabled = false;
        }, 1000);
      });
    });
    
// Add safe loading state to forms (without blocking submit)
    document.querySelectorAll('form').forEach(form => {
      form.addEventListener('submit', function() {
        const submitBtn = this.querySelector('button[type="submit"], button:not([type])');
        if (submitBtn) {
          // Delay changes to allow form to submit properly
          setTimeout(() => {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="spinner-border spinner-border-sm"></i> Loading...';
          }, 100);
        }
      });
    });

    
    // Add dynamic multiplier counter animation
    const multiplierElement = document.querySelector('.multiplier-glow');
    if (multiplierElement) {
      let currentMultiplier = parseFloat(multiplierElement.textContent);
      let targetMultiplier = currentMultiplier;
      
      function animateMultiplier() {
        if (Math.abs(currentMultiplier - targetMultiplier) > 0.01) {
          currentMultiplier += (targetMultiplier - currentMultiplier) * 0.1;
          multiplierElement.textContent = currentMultiplier.toFixed(2) + 'x';
          requestAnimationFrame(animateMultiplier);
        }
      }
      
      // Start animation if needed
      animateMultiplier();
    }
    
    // Add visual feedback for successful cash out
    const cashOutBtn = document.querySelector('.btn-cash-out');
    if (cashOutBtn) {
      cashOutBtn.addEventListener('click', function(e) {
        // Add success animation
        this.innerHTML = '<i class="bi bi-check-circle"></i> Cashing Out...';
        this.style.background = 'rgba(40,167,69,0.8)';
        
        // Create celebration particles
        for (let i = 0; i < 10; i++) {
          const particle = document.createElement('div');
          particle.style.position = 'fixed';
          particle.style.left = e.clientX + 'px';
          particle.style.top = e.clientY + 'px';
          particle.style.width = '6px';
          particle.style.height = '6px';
          particle.style.background = '#ffd700';
          particle.style.borderRadius = '50%';
          particle.style.pointerEvents = 'none';
          particle.style.zIndex = '9999';
          
          const angle = (i / 10) * Math.PI * 2;
          const velocity = 100;
          const vx = Math.cos(angle) * velocity;
          const vy = Math.sin(angle) * velocity;
          
          particle.style.animation = `
            particle-burst 1s ease-out forwards
          `;
          
          document.body.appendChild(particle);
          
          setTimeout(() => particle.remove(), 1000);
        }
      });
    }
    
    // Add particle burst animation
    const particleBurstStyle = document.createElement('style');
    particleBurstStyle.textContent = `
      @keyframes particle-burst {
        0% {
          transform: translate(0, 0) scale(1);
          opacity: 1;
        }
        100% {
          transform: translate(var(--dx, 50px), var(--dy, -50px)) scale(0);
          opacity: 0;
        }
      }
    `;
    document.head.appendChild(particleBurstStyle);
  </script>
</body>
</html>